<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ êµ¬ìŠ¬ ë ˆì´ìŠ¤ (Marble Run)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { margin: 0; background: #1a1a1b; color: white; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; }
        #game-container { position: relative; width: 500px; height: 600px; background: #222; border: 5px solid #333; margin-top: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .controls { background: #333; padding: 15px; border-radius: 10px; width: 470px; margin-top: 10px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        textarea { width: 100%; height: 50px; background: #111; color: white; border: 1px solid #444; padding: 8px; box-sizing: border-box; border-radius: 5px; margin-bottom: 10px; }
        
        .option-group { display: flex; justify-content: space-around; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .option-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        
        button { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; transition: 0.2s; }
        #dropBtn { background: #5865F2; color: white; font-size: 1.1rem; }
        #dropBtn:hover { background: #4752c4; }
        #saveBtn { background: #3ba55c; color: white; }
        
        #resultDisplay { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 3.5rem; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px gold; color: gold; display: none; z-index: 10; text-align: center; width: 100%; }
        .room-info { font-size: 12px; color: #888; margin-bottom: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="resultDisplay"></div>
    </div>

    <div class="controls">
        <div class="room-info">
            <span>ë°© ID: <b id="roomIdDisp"></b></span>
            <a href="#" onclick="copyLink()" style="color:#5865F2; text-decoration:none;">ë§í¬ ë³µì‚¬</a>
        </div>
        
        <textarea id="nameInput" placeholder="ì´ë¦„ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: ì² ìˆ˜, ì˜í¬, ë¯¼ìˆ˜*2)"></textarea>
        
        <div class="option-group">
            <span>ğŸ† ë‹¹ì²¨ ì¡°ê±´:</span>
            <label><input type="radio" name="winType" value="first" checked> 1ë“± (ì²˜ìŒ)</label>
            <label><input type="radio" name="winType" value="last"> ê¼´ì°Œ (ë§ˆì§€ë§‰)</label>
        </div>

        <button id="saveBtn" onclick="saveData()">âœ… ì„¤ì • ì €ì¥ (ëª¨ë‘ì—ê²Œ ì ìš©)</button>
        <button id="dropBtn" onclick="triggerDrop()">ğŸ”® êµ¬ìŠ¬ ë ˆì´ìŠ¤ ì‹œì‘!</button>
    </div>

    <script>
        // === [ì„¤ì •] Firebase ì„¤ì •ê°’ì„ ë„£ìœ¼ì„¸ìš” ===
        const firebaseConfig = {
  apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
  authDomain: "random-game-22f1a.firebaseapp.com",
  databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-game-22f1a",
  storageBucket: "random-game-22f1a.firebasestorage.app",
  messagingSenderId: "1091564497932",
  appId: "1:1091564497932:web:a16dc96fb998166dea9229"
};
        // =====================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 7);
        if (!window.location.search.includes('room')) window.history.pushState({}, '', `?room=${roomId}`);
        document.getElementById('roomIdDisp').innerText = roomId;

        function copyLink() { navigator.clipboard.writeText(window.location.href); alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!"); }

        // Matter.js ì„¤ì •
        const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 500, height: 600, wireframes: false, background: '#222' }
        });

        // ë²½ ìƒì„±
        const wallOptions = { isStatic: true, render: { fillStyle: '#444' } };
        Composite.add(engine.world, [
            Bodies.rectangle(250, 610, 500, 20, wallOptions), // ë°”ë‹¥
            Bodies.rectangle(-10, 300, 20, 600, wallOptions), // ì™¼ìª½
            Bodies.rectangle(510, 300, 20, 600, wallOptions)  // ì˜¤ë¥¸ìª½
        ]);

        // í•€(ì¥ì• ë¬¼) ë°°ì¹˜
        for (let row = 0; row < 7; row++) {
            for (let col = 0; col < 9; col++) {
                let x = col * 55 + (row % 2 === 0 ? 30 : 55);
                let y = row * 70 + 100;
                if (x < 480) Composite.add(engine.world, Bodies.circle(x, y, 4, { isStatic: true, render: { fillStyle: '#666' } }));
            }
        }

        Render.run(render);
        Runner.run(Runner.create(), engine);

        // êµ¬ìŠ¬ ìœ„ì— ì´ë¦„ ê·¸ë¦¬ê¸° ì»¤ìŠ¤í…€
        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            ctx.font = "bold 12px Arial";
            ctx.textAlign = "center";
            ctx.fillStyle = "white";
            
            const bodies = Composite.allBodies(engine.world);
            bodies.forEach(body => {
                if (body.label && body.label !== 'Body') {
                    ctx.fillText(body.label, body.position.x, body.position.y - 15);
                }
            });
        });

        let names = [];
        let winCondition = 'first'; 
        const resultDisplay = document.getElementById('resultDisplay');

        // Firebase ë™ê¸°í™”
        db.ref(`rooms/${roomId}/config`).on('value', snap => {
            const val = snap.val();
            if (val) {
                document.getElementById('nameInput').value = val.names || "";
                winCondition = val.winType || 'first';
                document.querySelector(`input[value="${winCondition}"]`).checked = true;
                parseNames(val.names);
            }
        });

        db.ref(`rooms/${roomId}/drop`).on('value', snap => {
            if (snap.val()) dropMarbles();
        });

        function parseNames(str) {
            names = [];
            str.split(',').forEach(n => {
                let part = n.trim();
                if (part.includes('*')) {
                    let [nm, count] = part.split('*');
                    for (let i = 0; i < parseInt(count || 1); i++) names.push(nm.trim());
                } else if (part) names.push(part);
            });
        }

        function saveData() {
            const config = {
                names: document.getElementById('nameInput').value,
                winType: document.querySelector('input[name="winType"]:checked').value
            };
            db.ref(`rooms/${roomId}/config`).set(config);
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function triggerDrop() {
            db.ref(`rooms/${roomId}/drop`).set(Date.now());
        }

        function dropMarbles() {
            resultDisplay.style.display = 'none';
            const existingBalls = Composite.allBodies(engine.world).filter(b => !b.isStatic);
            existingBalls.forEach(b => Composite.remove(engine.world, b));

            let finishedCount = 0;
            const totalBalls = names.length;

            names.forEach((name, i) => {
                setTimeout(() => {
                    const ball = Bodies.circle(250 + (Math.random() * 60 - 30), 30, 12, {
                        restitution: 0.6, friction: 0.01, label: name,
                        render: { fillStyle: `hsl(${Math.random() * 360}, 70%, 60%)` }
                    });
                    Composite.add(engine.world, ball);
                }, i * 150);
            });

            // ë„ì°© ê°ì§€ ë¡œì§
            const checkFinish = setInterval(() => {
                const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic);
                balls.forEach(ball => {
                    if (ball.position.y > 570 && !ball.isFinished) {
                        ball.isFinished = true;
                        finishedCount++;

                        // ë‹¹ì²¨ ì¡°ê±´ í™•ì¸
                        if (winCondition === 'first' && finishedCount === 1) {
                            showWinner(ball.label);
                        } else if (winCondition === 'last' && finishedCount === totalBalls) {
                            showWinner(ball.label);
                        }
                    }
                });
                if (finishedCount === totalBalls) clearInterval(checkFinish);
            }, 100);
        }

        function showWinner(name) {
            resultDisplay.innerText = `ğŸ† ë‹¹ì²¨\n${name}`;
            resultDisplay.style.display = 'block';
            setTimeout(() => db.ref(`rooms/${roomId}/drop`).set(null), 5000);
        }
    </script>
</body>
</html>
