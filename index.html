<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµ¬ìŠ¬ ë ˆì´ìŠ¤ - ì‹¤ì‹œê°„ ë§µ ì—ë””í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { margin: 0; background: #1a1a1b; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-y: auto; }
        #game-container { position: relative; width: 400px; height: 1000px; background: #222; border: 5px solid #333; margin-top: 20px; cursor: crosshair; }
        .controls { background: #333; padding: 15px; border-radius: 10px; width: 370px; margin: 20px 0; z-index: 100; }
        textarea { width: 100%; height: 50px; background: #111; color: white; border: 1px solid #444; padding: 8px; box-sizing: border-box; border-radius: 5px; margin-bottom: 10px; resize: none; }
        .toolbar { display: flex; gap: 5px; margin-bottom: 10px; background: #222; padding: 10px; border-radius: 5px; flex-wrap: wrap; }
        .toolbar button { flex: 1; min-width: 80px; font-size: 11px; padding: 5px; background: #444; color: white; border: 1px solid #555; }
        .toolbar button.active { background: #5865F2; border-color: #fff; }
        .btn-main { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; }
        #dropBtn { background: #5865F2; color: white; }
        #saveMapBtn { background: #3ba55c; color: white; margin-bottom: 5px; }
        #resultDisplay { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px gold; color: gold; display: none; z-index: 10; text-align: center; width: 100%; white-space: pre-wrap; }
        .hint { font-size: 11px; color: #aaa; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="resultDisplay"></div>
    </div>

    <div class="controls">
        <div class="toolbar">
            <button id="tool-pin" class="active" onclick="setTool('pin')">ğŸ“ í•€ ë°°ì¹˜</button>
            <button id="tool-spinner" onclick="setTool('spinner')">ğŸ”„ íšŒì „íŒ</button>
            <button onclick="clearMap()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
        </div>
        
        <button id="saveMapBtn" class="btn-main" onclick="saveMapData()">ğŸ’¾ í˜„ì¬ ë§µ ì €ì¥ (ì „ì²´ ê³µìœ )</button>
        
        <textarea id="nameInput" placeholder="ì´ë¦„ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: ì² ìˆ˜, ì˜í¬)"></textarea>
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <label style="font-size: 12px;"><input type="radio" name="winType" value="first" checked> ì²˜ìŒ í†µê³¼</label>
            <label style="font-size: 12px;"><input type="radio" name="winType" value="last"> ë§ˆì§€ë§‰ í†µê³¼</label>
        </div>

        <button id="dropBtn" class="btn-main" onclick="triggerDrop()">ğŸ”® ë ˆì´ìŠ¤ ì‹œì‘!</button>
        <div class="hint">ë§µì„ í´ë¦­í•˜ì—¬ ì¥ì• ë¬¼ì„ ë°°ì¹˜í•˜ì„¸ìš”.</div>
    </div>

    <script>
        // === [í•„ë…] Firebase ì„¤ì • ===
        const firebaseConfig = {
  apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
  authDomain: "random-game-22f1a.firebaseapp.com",
  databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-game-22f1a",
  storageBucket: "random-game-22f1a.firebasestorage.app",
  messagingSenderId: "1091564497932",
  appId: "1:1091564497932:web:a16dc96fb998166dea9229"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 7);
        if (!window.location.search.includes('room')) window.history.pushState({}, '', `?room=${roomId}`);

        const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 400, height: 1000, wireframes: false, background: '#222' }
        });

        // ê¸°ë³¸ ë²½ ë° í•˜ë‹¨ ë°°ì¶œêµ¬
        const wallOpt = { isStatic: true, render: { fillStyle: '#444' } };
        const staticWalls = [
            Bodies.rectangle(200, 1010, 400, 20, wallOpt), // ë°”ë‹¥
            Bodies.rectangle(-10, 500, 20, 1000, wallOpt), // ì™¼ë²½
            Bodies.rectangle(410, 500, 20, 1000, wallOpt), // ì˜¤ë¥¸ë²½
            // ê¹”ë•Œê¸°
            Bodies.rectangle(100, 950, 250, 10, { ...wallOpt, angle: 1.2 }),
            Bodies.rectangle(300, 950, 250, 10, { ...wallOpt, angle: -1.2 }),
            Bodies.rectangle(190, 990, 5, 40, wallOpt),
            Bodies.rectangle(210, 990, 5, 40, wallOpt)
        ];
        Composite.add(engine.world, staticWalls);

        const gate = Bodies.rectangle(200, 30, 400, 10, { isStatic: true, render: { visible: false } });
        Composite.add(engine.world, gate);

        Render.run(render);
        Runner.run(Runner.create(), engine);

        // --- ì—ë””í„° ê¸°ëŠ¥ ---
        let currentTool = 'pin';
        let mapObjects = []; // {x, y, type}
        let spinners = [];

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.toolbar button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tool-${tool}`).classList.add('active');
        }

        document.getElementById('game-container').addEventListener('mousedown', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (y > 900 || y < 50) return; // ìƒë‹¨/í•˜ë‹¨ ê¸ˆì§€êµ¬ì—­

            mapObjects.push({ x, y, type: currentTool });
            updatePhysicsObjects();
        });

        function clearMap() {
            mapObjects = [];
            updatePhysicsObjects();
        }

        function updatePhysicsObjects() {
            // ê¸°ì¡´ ì¥ì• ë¬¼ë“¤ë§Œ ì œê±° (ë²½, ê²Œì´íŠ¸, êµ¬ìŠ¬ ì œì™¸)
            const allBodies = Composite.allBodies(engine.world);
            allBodies.forEach(b => {
                if (b.isCustom) Composite.remove(engine.world, b);
            });
            spinners = [];

            mapObjects.forEach(obj => {
                if (obj.type === 'pin') {
                    const pin = Bodies.circle(obj.x, obj.y, 5, { isStatic: true, restitution: 1.2, render: { fillStyle: '#777' } });
                    pin.isCustom = true;
                    Composite.add(engine.world, pin);
                } else if (obj.type === 'spinner') {
                    const group = Body.nextGroup(true);
                    const disk = Bodies.circle(obj.x, obj.y, 35, { isStatic: true, render: { fillStyle: '#5865F2' } });
                    const bar = Bodies.rectangle(obj.x, obj.y, 70, 8, { isStatic: true, render: { fillStyle: '#fff' } });
                    disk.isCustom = true;
                    bar.isCustom = true;
                    spinners.push({ bar, speed: 0.05 });
                    Composite.add(engine.world, [disk, bar]);
                }
            });
        }

        // --- ë°ì´í„° ì €ì¥/ë¡œë“œ ---
        function saveMapData() {
            db.ref(`rooms/${roomId}/mapData`).set(mapObjects);
            const config = { 
                names: document.getElementById('nameInput').value, 
                winType: document.querySelector('input[name="winType"]:checked').value 
            };
            db.ref(`rooms/${roomId}/config`).set(config);
            alert("ë§µê³¼ ëª…ë‹¨ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        db.ref(`rooms/${roomId}/mapData`).on('value', snap => {
            const val = snap.val();
            if (val) {
                mapObjects = val;
                updatePhysicsObjects();
                setupMarbles();
            }
        });

        // --- ë ˆì´ìŠ¤ ë¡œì§ ---
        Events.on(engine, 'beforeUpdate', () => {
            spinners.forEach(s => Body.setAngle(s.bar, s.bar.angle + s.speed));
        });

        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center";
            Composite.allBodies(engine.world).forEach(body => {
                if (body.label && body.label !== 'Body' && !body.isStatic) {
                    const {x, y} = body.position;
                    ctx.fillStyle = "rgba(0,0,0,0.6)";
                    const tw = ctx.measureText(body.label).width;
                    ctx.fillRect(x - tw/2 - 4, y - 32, tw + 8, 18);
                    ctx.fillStyle = "white"; ctx.fillText(body.label, x, y - 18);
                }
            });
        });

        let names = [];
        let isRunning = false;

        db.ref(`rooms/${roomId}/config`).on('value', snap => {
            const val = snap.val();
            if (val) {
                document.getElementById('nameInput').value = val.names || "";
                document.querySelector(`input[value="${val.winType || 'first'}"]`).checked = true;
                parseNames(val.names);
                setupMarbles();
            }
        });

        db.ref(`rooms/${roomId}/drop`).on('value', snap => { if (snap.val()) startRace(); });

        function parseNames(str) {
            names = [];
            str.split(',').forEach(n => {
                let p = n.trim();
                if (p.includes('*')) {
                    let [nm, c] = p.split('*');
                    for (let i = 0; i < (parseInt(c) || 1); i++) names.push(nm.trim());
                } else if (p) names.push(p);
            });
        }

        function setupMarbles() {
            if (isRunning) return;
            const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && !b.isCustom);
            balls.forEach(b => Composite.remove(engine.world, b));
            document.getElementById('resultDisplay').style.display = 'none';
            names.forEach((name, i) => {
                const ball = Bodies.circle(180 + (Math.random() * 40), 15, 10, {
                    restitution: 0.5, friction: 0, label: name,
                    render: { fillStyle: `hsl(${Math.random() * 360}, 70%, 60%)` }
                });
                Composite.add(engine.world, ball);
            });
        }

        function triggerDrop() { db.ref(`rooms/${roomId}/drop`).set(Date.now()); }

        function startRace() {
            if (isRunning) return;
            isRunning = true;
            Composite.remove(engine.world, gate);
            let finished = 0; const total = names.length;
            const check = setInterval(() => {
                const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && !b.isCustom);
                balls.forEach(ball => {
                    if (ball.position.y > 985 && !ball.isDone) {
                        ball.isDone = true; finished++;
                        const winType = document.querySelector('input[name="winType"]:checked').value;
                        if (winType === 'first' && finished === 1) showWinner(ball.label);
                        else if (winType === 'last' && finished === total) showWinner(ball.label);
                    }
                });
                if (finished === total) { clearInterval(check); isRunning = false; Composite.add(engine.world, gate); }
            }, 100);
        }

        function showWinner(name) {
            const res = document.getElementById('resultDisplay');
            res.innerText = `ğŸ† ë‹¹ì²¨ ğŸ†\n${name}`;
            res.style.display = 'block';
            setTimeout(() => db.ref(`rooms/${roomId}/drop`).set(null), 5000);
        }
    </script>
</body>
</html>
