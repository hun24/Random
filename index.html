<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ êµ¬ìŠ¬ ë ˆì´ìŠ¤ - íšŒì „íŒ í•€ë³¼ ë§µ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { margin: 0; background: #1a1a1b; color: white; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-y: auto; }
        #game-container { position: relative; width: 400px; height: 1600px; background: #2a2a2a; border: 5px solid #333; margin-top: 20px; cursor: crosshair; }
        .controls { background: #333; padding: 15px; border-radius: 10px; width: 370px; margin: 20px 0; z-index: 100; }
        textarea { width: 100%; height: 50px; background: #111; color: white; border: 1px solid #444; padding: 8px; box-sizing: border-box; border-radius: 5px; margin-bottom: 10px; resize: none; }
        .option-group { display: flex; justify-content: space-around; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; }
        .small-btn { width: 48%; display: inline-block; }
        #dropBtn { background: #5865F2; color: white; font-size: 1.1rem; }
        #saveBtn { background: #3ba55c; color: white; }
        #resetBtn { background: #ed4245; color: white; }
        #editModeBtn { background: #faa61a; color: white; }
        #saveMapBtn { background: #9b59b6; color: white; }
        #loadMapBtn { background: #3498db; color: white; }
        #clearMapBtn { background: #e74c3c; color: white; }
        #resultDisplay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px gold; color: gold; display: none; z-index: 10; text-align: center; width: 100%; white-space: pre-wrap; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .edit-controls { display: none; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .edit-controls.active { display: block; }
        .tool-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .tool-btn { flex: 1; padding: 8px; background: #444; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .tool-btn.active { background: #5865F2; }
        input[type="range"] { width: 100%; }
        .param-group { margin: 10px 0; }
        .param-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        #editStatus { background: #555; padding: 8px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="controls" style="margin-bottom: 5px; background: #2c2f33;">
        <div style="display: flex; gap: 10px; align-items: center; justify-content: center;">
            <span style="font-weight: bold; color: #5865F2;">í˜„ì¬ ë°©: <span id="currentRoomDisplay"></span></span>
            <input type="text" id="roomInput" placeholder="ë°© ë²ˆí˜¸ ì…ë ¥" style="width: 80px; padding: 5px; border-radius: 3px; border: none;">
            <button class="small-btn" onclick="changeRoom()" style="width: auto; padding: 5px 15px; margin: 0; background: #5865F2;">ì´ë™</button>
            <button class="small-btn" onclick="randomRoom()" style="width: auto; padding: 5px 15px; margin: 0; background: #72767d;">ëœë¤ ë°©</button>
        </div>
    </div>
    
    <div id="game-container">
        <div id="resultDisplay"></div>
    </div>

    <div class="controls">
        <textarea id="nameInput" placeholder="ì´ë¦„ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: ì² ìˆ˜, ì˜í¬, ë¯¼ìˆ˜*3)"></textarea>
        <div class="option-group">
            <label><input type="radio" name="winType" value="first" checked> ì²˜ìŒ í†µê³¼</label>
            <label><input type="radio" name="winType" value="last"> ë§ˆì§€ë§‰ í†µê³¼</label>
        </div>
        <button id="saveBtn" onclick="saveData()">âœ… ì„¤ì • ì €ì¥ & êµ¬ìŠ¬ ì„¸íŒ…</button>
        <button id="dropBtn" onclick="triggerDrop()" disabled>ğŸ”® ë ˆì´ìŠ¤ ì‹œì‘!</button>
        <button id="resetBtn" onclick="resetGame()">ğŸ”„ ì´ˆê¸°í™”</button>
        
        <div style="margin-top: 15px; border-top: 2px solid #444; padding-top: 15px;">
            <button id="editModeBtn" onclick="toggleEditMode()">ğŸ› ï¸ ë§µ í¸ì§‘ ëª¨ë“œ</button>
            
            <div id="editControls" class="edit-controls">
                <div id="editStatus">í¸ì§‘ ëª¨ë“œ: í´ë¦­í•˜ì—¬ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€</div>
                
                <div class="tool-group">
                    <button class="tool-btn active" onclick="selectTool('wall')">ğŸ§± ë²½</button>
                    <button class="tool-btn" onclick="selectTool('spinner')">ğŸ”„ íšŒì „íŒ</button>
                    <button class="tool-btn" onclick="selectTool('pin')">ğŸ“ í•€</button>
                    <button class="tool-btn" onclick="selectTool('delete')">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                
                <div class="param-group">
                    <label>í¬ê¸°: <span id="sizeValue">50</span>px</label>
                    <input type="range" id="sizeSlider" min="10" max="200" value="50" oninput="updateSize(this.value)">
                </div>
                
                <div class="param-group">
                    <label>ê°ë„: <span id="angleValue">0</span>Â°</label>
                    <input type="range" id="angleSlider" min="-180" max="180" value="0" oninput="updateAngle(this.value)">
                </div>
                
                <div class="param-group" id="speedControl" style="display:none;">
                    <label>íšŒì „ ì†ë„: <span id="speedValue">0.05</span></label>
                    <input type="range" id="speedSlider" min="-0.1" max="0.1" step="0.01" value="0.05" oninput="updateSpeed(this.value)">
                </div>
                
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="small-btn" id="saveMapBtn" onclick="saveMap()">ğŸ’¾ ë§µ ì €ì¥</button>
                    <button class="small-btn" id="loadMapBtn" onclick="loadMap()">ğŸ“‚ ë§µ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                <button class="tool-btn" onclick="undo()" style="background: #72767d; margin-top:5px;">â†©ï¸ ë˜ëŒë¦¬ê¸° (Ctrl+Z)</button>
                <button id="clearMapBtn" onclick="clearCustomMap()">ğŸ—‘ï¸ ì»¤ìŠ¤í…€ ì˜¤ë¸Œì íŠ¸ ëª¨ë‘ ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <script>
        // === [ì„¤ì •] Firebase Config ===
        const firebaseConfig = {
  apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
  authDomain: "random-game-22f1a.firebaseapp.com",
  databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-game-22f1a",
  storageBucket: "random-game-22f1a.firebasestorage.app",
  messagingSenderId: "1091564497932",
  appId: "1:1091564497932:web:a16dc96fb998166dea9229"
};
        // ============================

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        // 2. Matter.js ì—”ì§„ ì„¤ì •
        const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
        
        let engine, render, runner;
        let names = [];
        let winCondition = 'first';
        let isRunning = false;
        let marblesCreated = false;
        let spinners = [];
        let isHost = false; // ë‚´ê°€ ë°©ì¥ì¸ì§€ ì—¬ë¶€
        
        // í¸ì§‘ ê´€ë ¨ ë³€ìˆ˜
        let editMode = false;
        let currentTool = 'wall', currentSize = 100, currentAngle = 0, currentSpeed = 0.05;
        let undoStack = [], mousePos = { x: 0, y: 0 }, dragStart = null;
        
        const roomId = new URLSearchParams(window.location.search).get('room') || 'default';
        document.getElementById('currentRoomDisplay').textContent = roomId;
        
        // --- ê²Œì„ ì´ˆê¸°í™” ---
        function initGame() {
            engine = Engine.create();
            render = Render.create({
                element: document.getElementById('game-container'),
                engine: engine,
                options: { width: 400, height: 1600, wireframes: false, background: '#1a1a1a' }
            });
        
            const wallOpt = { isStatic: true, render: { fillStyle: '#333' } };
            const ground = Bodies.rectangle(200, 1610, 400, 20, { ...wallOpt, label: 'boundary' });
            const gate = Bodies.rectangle(200, 50, 400, 10, { isStatic: true, render: { fillStyle: '#ff4444' }, label: 'gate' });
            Composite.add(engine.world, [
                Bodies.rectangle(0, 800, 20, 1600, wallOpt),
                Bodies.rectangle(400, 800, 20, 1600, wallOpt),
                ground, gate
            ]);
        
            runner = Runner.create();
            Runner.run(runner, engine);
            Render.run(render);
        
            // ë Œë”ë§ ë£¨í”„ (ì´ë¦„í‘œ ë° ë¯¸ë¦¬ë³´ê¸°)
            Events.on(render, 'afterRender', () => {
                const ctx = render.context;
                if (editMode) {
                    ctx.save(); ctx.globalAlpha = 0.4;
                    if (currentTool === 'pin') {
                        ctx.beginPath(); ctx.arc(mousePos.x, mousePos.y, currentSize/5, 0, Math.PI*2);
                        ctx.fillStyle = '#ff00ff'; ctx.fill();
                    } else if (!dragStart) {
                        ctx.translate(mousePos.x, mousePos.y); ctx.rotate(currentAngle);
                        ctx.fillStyle = (currentTool === 'spinner') ? '#ffff00' : '#00ff00';
                        ctx.fillRect(-currentSize/2, (currentTool==='spinner'?-4:-5), currentSize, (currentTool==='spinner'?8:10));
                    }
                    ctx.restore();
                    if (dragStart && (currentTool === 'wall' || currentTool === 'spinner')) {
                        ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.moveTo(dragStart.x, dragStart.y);
                        ctx.lineTo(mousePos.x, mousePos.y); ctx.strokeStyle = (currentTool==='wall'?'#00ff00':'#ffff00'); ctx.stroke();
                    }
                }
                Composite.allBodies(engine.world).forEach(body => {
                    if (body.label && !['gate','boundary','custom','default'].includes(body.label)) {
                        ctx.fillStyle = "white"; ctx.font = "bold 11px sans-serif"; ctx.textAlign = "center";
                        ctx.fillText(body.label, body.position.x, body.position.y - 12);
                    }
                });
            });
        
            Events.on(engine, 'beforeUpdate', () => {
                spinners.forEach(s => Matter.Body.setAngle(s.body, s.body.angle + s.speed));
            });
        
            // [ë™ê¸°í™”] íƒ€ì¸ì´ ì‹œì‘í•˜ê±°ë‚˜ ê²°ê³¼ê°€ ë‚˜ì™”ì„ ë•Œ ê°ì§€
            db.ref(`rooms/${roomId}/raceState`).on('value', snap => {
                const state = snap.val();
                if (state === 'start' && !isRunning) startRace(false); // íƒ€ì¸ì´ ì‹œì‘ ëˆ„ë¦„
                if (state === 'ready') resetGameUI();
            });
        
            db.ref(`rooms/${roomId}/winner`).on('value', snap => {
                const winner = snap.val();
                if (winner) showWinner(winner); // ëª¨ë‘ì—ê²Œ ë™ì¼í•œ ìš°ìŠ¹ì í‘œì‹œ
            });
        }
        
        // --- ë ˆì´ìŠ¤ ì œì–´ ---
        function startRace(isInitiator = true) {
            if (isRunning) return;
            isRunning = true;
            isHost = isInitiator; // ì‹œì‘ ë²„íŠ¼ ëˆ„ë¥¸ ì‚¬ëŒì´ ë°©ì¥
        
            if (isHost) {
                db.ref(`rooms/${roomId}/winner`).set(null); // ê²°ê³¼ ì´ˆê¸°í™”
                db.ref(`rooms/${roomId}/raceState`).set('start'); // ëª¨ë‘ ì‹œì‘
            }
        
            const gate = Composite.allBodies(engine.world).find(b => b.label === 'gate');
            if (gate) Composite.remove(engine.world, gate);
            
            let finished = 0;
            const total = names.length;
        
            const collisionHandler = (event) => {
                event.pairs.forEach(pair => {
                    const { bodyA, bodyB } = pair;
                    const ball = [bodyA, bodyB].find(b => !b.isStatic && b.label !== 'boundary' && !b.isDone);
                    const isFloor = [bodyA, bodyB].some(b => b.label === 'boundary');
        
                    if (ball && isFloor) {
                        ball.isDone = true;
                        finished++;
                        
                        // [í•µì‹¬] ë°©ì¥ë§Œ Firebaseì— ê²°ê³¼ë¥¼ ê¸°ë¡í•¨
                        if (isHost) {
                            if ((winCondition === 'first' && finished === 1) || (winCondition === 'last' && finished === total)) {
                                db.ref(`rooms/${roomId}/winner`).set(ball.label);
                            }
                        }
                        
                        Composite.remove(engine.world, ball);
                        if (finished === total) {
                            Events.off(engine, 'collisionStart', collisionHandler);
                            isRunning = false;
                            if (isHost) db.ref(`rooms/${roomId}/raceState`).set('ready');
                        }
                    }
                });
            };
            Events.on(engine, 'collisionStart', collisionHandler);
        }
        
        // --- í¸ì§‘ ë° ê°ì²´ ìƒì„± í•¨ìˆ˜ë“¤ ---
        const gameContainer = document.getElementById('game-container');
        gameContainer.addEventListener('mousedown', (e) => {
            if (!editMode || ['delete','pin'].includes(currentTool)) return;
            const rect = gameContainer.getBoundingClientRect();
            dragStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        });
        
        gameContainer.addEventListener('mousemove', (e) => {
            const rect = gameContainer.getBoundingClientRect();
            mousePos.x = e.clientX - rect.left; mousePos.y = e.clientY - rect.top;
        });
        
        gameContainer.addEventListener('mouseup', (e) => {
            if (!editMode) return;
            const rect = gameContainer.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            if (currentTool === 'delete') deleteObjectAt(x, y);
            else if (currentTool === 'pin') addPin(x, y);
            else if (dragStart) addDraggedObject(dragStart.x, dragStart.y, x, y);
            dragStart = null;
        });
        
        function addPin(x, y) {
            const r = currentSize/5;
            const body = Bodies.circle(x, y, r, { isStatic: true, label: 'custom', render: { fillStyle: '#ff00ff' }, restitution: 0.5, myInternalData: { w: r, h: r } });
            Composite.add(engine.world, body); pushToUndoStack('add', { body });
        }
        
        function addDraggedObject(x1, y1, x2, y2) {
            const dx = x2-x1, dy = y2-y1, dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 5) return;
            const angle = Math.atan2(dy, dx), thickness = (currentTool==='spinner'?8:10);
            const body = Bodies.rectangle((x1+x2)/2, (y1+y2)/2, dist, thickness, { isStatic: true, angle, label: 'custom', render: { fillStyle: (currentTool==='spinner'?'#ffff00':'#00ff00') }, myInternalData: { w: dist, h: thickness } });
            if (currentTool==='spinner') spinners.push({ body, speed: currentSpeed });
            Composite.add(engine.world, body); pushToUndoStack('add', { body });
        }
        
        function deleteObjectAt(x, y) {
            const bodies = Composite.allBodies(engine.world);
            for (let body of bodies) {
                if (body.label !== 'custom' && body.label !== 'default') continue;
                if (Matter.Bounds.contains(body.bounds, { x, y })) {
                    const s = spinners.find(sp => sp.body === body);
                    pushToUndoStack('delete', { label: body.label, x: body.position.x, y: body.position.y, width: body.myInternalData?.w || 50, height: body.myInternalData?.h || 10, angle: body.angle, speed: s?.speed || 0, type: body.circleRadius?'pin':(s?'spinner':'wall'), color: body.render.fillStyle, radius: body.circleRadius || 0 });
                    Composite.remove(engine.world, body);
                    if (s) spinners.splice(spinners.indexOf(s), 1);
                    break;
                }
            }
        }
        
        // --- ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° (Undo, Save, Load, UI) ---
        function pushToUndoStack(type, data) { undoStack.push({ type, data }); if (undoStack.length > 50) undoStack.shift(); }
        function undo() {
            if (undoStack.length === 0) return;
            const a = undoStack.pop();
            if (a.type === 'add') {
                Composite.remove(engine.world, a.data.body);
                const idx = spinners.findIndex(s => s.body === a.data.body); if (idx!==-1) spinners.splice(idx, 1);
            } else {
                const o = a.data; let opt = { isStatic: true, angle: o.angle, label: o.label, render: { fillStyle: o.color }, myInternalData: { w: o.width, h: o.height } };
                let body = o.type==='pin' ? Bodies.circle(o.x, o.y, o.radius, opt) : Bodies.rectangle(o.x, o.y, o.width, o.height, opt);
                if (o.type==='spinner') spinners.push({ body, speed: o.speed });
                Composite.add(engine.world, body);
            }
        }
        
        function saveMap() {
            const data = Composite.allBodies(engine.world).filter(b => b.label === 'custom' || b.label === 'default').map(b => {
                const s = spinners.find(sp => sp.body === b);
                return { label: b.label, x: b.position.x, y: b.position.y, angle: b.angle, width: b.myInternalData?.w || 50, height: b.myInternalData?.h || 10, type: b.circleRadius?'pin':(s?'spinner':'wall'), speed: s?.speed || 0, radius: b.circleRadius || 0, color: b.render.fillStyle };
            });
            db.ref(`rooms/${roomId}/customMap`).set(data); alert('ë§µ ì €ì¥ ì™„ë£Œ!');
        }
        
        function loadMap() {
            db.ref(`rooms/${roomId}/customMap`).once('value', snap => {
                const data = snap.val(); if (!data) return alert('ë§µ ì—†ìŒ');
                Composite.allBodies(engine.world).forEach(b => { if (b.label === 'custom' || b.label === 'default') Composite.remove(engine.world, b); });
                spinners = [];
                data.forEach(o => {
                    let opt = { isStatic: true, angle: o.angle, label: o.label, render: { fillStyle: o.color }, myInternalData: { w: o.width, h: o.height } };
                    let body = o.type==='pin' ? Bodies.circle(o.x, o.y, o.radius, opt) : Bodies.rectangle(o.x, o.y, o.width, o.height, opt);
                    if (o.type==='spinner') spinners.push({ body, speed: o.speed });
                    Composite.add(engine.world, body);
                });
                alert('ë§µ ë¡œë“œ ì™„ë£Œ!');
            });
        }
        
        function changeRoom() { const v = document.getElementById('roomInput').value.trim(); if(v) window.location.href=`?room=${v}`; }
        function randomRoom() { window.location.href=`?room=${Math.random().toString(36).substring(2,7)}`; }
        window.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'z') undo(); });
        
        initGame();
    </script>
</body>
</html>
