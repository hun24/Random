<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ êµ¬ìŠ¬ ë ˆì´ìŠ¤ - íšŒì „íŒ í•€ë³¼ ë§µ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { margin: 0; background: #1a1a1b; color: white; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-y: auto; }
        #game-container { position: relative; width: 400px; height: 1600px; background: #2a2a2a; border: 5px solid #333; margin-top: 20px; }
        .controls { background: #333; padding: 15px; border-radius: 10px; width: 370px; margin: 20px 0; z-index: 100; }
        textarea { width: 100%; height: 50px; background: #111; color: white; border: 1px solid #444; padding: 8px; box-sizing: border-box; border-radius: 5px; margin-bottom: 10px; resize: none; }
        .option-group { display: flex; justify-content: space-around; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; }
        #dropBtn { background: #5865F2; color: white; font-size: 1.1rem; }
        #saveBtn { background: #3ba55c; color: white; }
        #resetBtn { background: #ed4245; color: white; }
        #resultDisplay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px gold; color: gold; display: none; z-index: 10; text-align: center; width: 100%; white-space: pre-wrap; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="resultDisplay"></div>
    </div>

    <div class="controls">
        <textarea id="nameInput" placeholder="ì´ë¦„ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: ì² ìˆ˜, ì˜í¬, ë¯¼ìˆ˜*3)"></textarea>
        <div class="option-group">
            <label><input type="radio" name="winType" value="first" checked> ì²˜ìŒ í†µê³¼</label>
            <label><input type="radio" name="winType" value="last"> ë§ˆì§€ë§‰ í†µê³¼</label>
        </div>
        <button id="saveBtn" onclick="saveData()">âœ… ì„¤ì • ì €ì¥ & êµ¬ìŠ¬ ì„¸íŒ…</button>
        <button id="dropBtn" onclick="triggerDrop()" disabled>ğŸ”® ë ˆì´ìŠ¤ ì‹œì‘!</button>
        <button id="resetBtn" onclick="resetGame()">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>

    <script>
        // === [ì„¤ì •] Firebase Config ===
        const firebaseConfig = {
  apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
  authDomain: "random-game-22f1a.firebaseapp.com",
  databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-game-22f1a",
  storageBucket: "random-game-22f1a.firebasestorage.app",
  messagingSenderId: "1091564497932",
  appId: "1:1091564497932:web:a16dc96fb998166dea9229"
};
        // ============================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 7);
        if (!window.location.search.includes('room')) window.history.pushState({}, '', `?room=${roomId}`);

        const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
        const engine = Engine.create();
        engine.gravity.y = 1.0;
        
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 400, height: 1600, wireframes: false, background: '#2a2a2a' }
        });

        const wallOpt = { isStatic: true, render: { fillStyle: '#555' }, friction: 0.001 };
        const pinOpt = { isStatic: true, render: { fillStyle: '#888' }, restitution: 0.5 };

        // ì™¸ê³½ ë²½
        Composite.add(engine.world, [
            Bodies.rectangle(200, 1610, 400, 20, wallOpt), // ë°”ë‹¥
            Bodies.rectangle(-5, 800, 10, 1600, wallOpt), // ì™¼ë²½
            Bodies.rectangle(405, 800, 10, 1600, wallOpt), // ì˜¤ë¥¸ë²½
        ]);

        // ìƒë‹¨ ì…êµ¬ - ê¹”ë•Œê¸° í˜•íƒœ
        Composite.add(engine.world, [
            Bodies.rectangle(80, 100, 140, 10, { ...wallOpt, angle: 0.4 }),
            Bodies.rectangle(320, 100, 140, 10, { ...wallOpt, angle: -0.4 }),
            Bodies.rectangle(60, 180, 100, 10, { ...wallOpt, angle: -0.3 }),
            Bodies.rectangle(340, 180, 100, 10, { ...wallOpt, angle: 0.3 }),
        ]);

        // íšŒì „íŒê³¼ ë²½ ì •ì˜
        const spinners = [];
        
        // ì¤‘ì•™ ì„¹ì…˜ - ìŠ¤í”¼ì»¤ í˜•íƒœ (íšŒì „íŒê³¼ ê¸´ ë²½)
        // ì™¼ìª½ ê¸´ ë²½
        Composite.add(engine.world, [
            Bodies.rectangle(130, 380, 8, 180, wallOpt),
            Bodies.rectangle(130, 590, 8, 200, wallOpt),
        ]);
        
        // ì˜¤ë¥¸ìª½ ê¸´ ë²½
        Composite.add(engine.world, [
            Bodies.rectangle(270, 380, 8, 180, wallOpt),
            Bodies.rectangle(270, 590, 8, 200, wallOpt),
        ]);

        // ì¤‘ì•™ ìŠ¤í”¼ì»¤ ë¶€ë¶„ì˜ íšŒì „íŒë“¤ - ë” ëŠë¦¬ê²Œ, ë” ì‘ê²Œ
        const speakerSpinners = [
            {x: 160, y: 460, w: 28, h: 5, speed: 0.03},
            {x: 190, y: 460, w: 28, h: 5, speed: -0.03},
            {x: 160, y: 500, w: 28, h: 5, speed: -0.03},
            {x: 190, y: 500, w: 28, h: 5, speed: 0.03},
            {x: 160, y: 540, w: 28, h: 5, speed: 0.03},
            {x: 190, y: 540, w: 28, h: 5, speed: -0.03},
            
            {x: 210, y: 460, w: 28, h: 5, speed: 0.03},
            {x: 240, y: 460, w: 28, h: 5, speed: -0.03},
            {x: 210, y: 500, w: 28, h: 5, speed: -0.03},
            {x: 240, y: 500, w: 28, h: 5, speed: 0.03},
            {x: 210, y: 540, w: 28, h: 5, speed: 0.03},
            {x: 240, y: 540, w: 28, h: 5, speed: -0.03},
        ];

        speakerSpinners.forEach(s => {
            const spinner = Bodies.rectangle(s.x, s.y, s.w, s.h, {
                isStatic: true,
                render: { fillStyle: '#4a9eff' },
                chamfer: { radius: 2 },
                friction: 0,
                frictionStatic: 0
            });
            spinners.push({ body: spinner, speed: s.speed, type: 'rect' });
            Composite.add(engine.world, spinner);
        });

        // ì¤‘ë‹¨ ì„¹ì…˜ - íšŒì „íŒë“¤ì´ ìˆëŠ” í•€ë³¼ ì˜ì—­
        // ì–‘ì˜† ê¸´ ë²½
        Composite.add(engine.world, [
            Bodies.rectangle(80, 800, 8, 250, wallOpt),
            Bodies.rectangle(320, 800, 8, 250, wallOpt),
            Bodies.rectangle(80, 1100, 8, 200, wallOpt),
            Bodies.rectangle(320, 1100, 8, 200, wallOpt),
        ]);

        // ì¤‘ë‹¨ íšŒì „íŒë“¤ - ë” ëŠë¦¬ê²Œ, ë” ì§§ê²Œ
        const middleSpinners = [
            {x: 120, y: 750, w: 40, h: 6, speed: 0.04},
            {x: 280, y: 820, w: 40, h: 6, speed: -0.04},
            {x: 120, y: 900, w: 40, h: 6, speed: -0.035},
            {x: 280, y: 970, w: 40, h: 6, speed: 0.035},
            {x: 120, y: 1050, w: 40, h: 6, speed: 0.04},
            {x: 280, y: 1120, w: 40, h: 6, speed: -0.04},
            {x: 120, y: 1200, w: 40, h: 6, speed: -0.035},
        ];

        middleSpinners.forEach(s => {
            const spinner = Bodies.rectangle(s.x, s.y, s.w, s.h, {
                isStatic: true,
                render: { fillStyle: '#ff6b6b' },
                chamfer: { radius: 3 },
                friction: 0,
                frictionStatic: 0
            });
            spinners.push({ body: spinner, speed: s.speed, type: 'rect' });
            Composite.add(engine.world, spinner);
        });

        // í•€ë³¼ í•€ë“¤ (íŒŒì¹œì½” ìŠ¤íƒ€ì¼) - íšŒì „íŒ ì‚¬ì´ì‚¬ì´
        const pins = [];
        for (let row = 0; row < 12; row++) {
            const y = 750 + row * 55;
            const offset = row % 2 === 0 ? 0 : 25;
            for (let col = 0; col < 6; col++) {
                const x = 120 + col * 40 + offset;
                if (x > 100 && x < 300) {
                    pins.push(Bodies.circle(x, y, 5, pinOpt));
                }
            }
        }
        Composite.add(engine.world, pins);

        // í•˜ë‹¨ ê¹”ë•Œê¸° - ë” ë„“ê²Œ
        Composite.add(engine.world, [
            // ê¹”ë•Œê¸° ì‚¬ì„ 
            Bodies.rectangle(100, 1350, 220, 10, { ...wallOpt, angle: 0.6 }),
            Bodies.rectangle(300, 1350, 220, 10, { ...wallOpt, angle: -0.6 }),
        ]);

        // í•˜ë‹¨ ìµœì¢… êµ¬ê°„ - ì˜†ìœ¼ë¡œ ë¹ ì§€ì§€ ì•Šê²Œ ê¸´ ë²½ ì¶”ê°€
        Composite.add(engine.world, [
            // ì¢ì€ í†µë¡œë¡œ ê°€ê¸° ì „ ê°€ì´ë“œ ë²½
            Bodies.rectangle(140, 1450, 8, 100, wallOpt),
            Bodies.rectangle(260, 1450, 8, 100, wallOpt),
            
            // ìµœì¢… í†µë¡œ ë²½ - ë” ê¸¸ê²Œ
            Bodies.rectangle(185, 1520, 8, 160, wallOpt),
            Bodies.rectangle(215, 1520, 8, 160, wallOpt),
            
            // ìµœì¢… ì¶œêµ¬ ë²½ - ì˜†ìœ¼ë¡œ ë¹ ì§€ì§€ ì•Šê²Œ
            Bodies.rectangle(165, 1590, 30, 8, wallOpt), // ì™¼ìª½ ì°¨ë‹¨
            Bodies.rectangle(235, 1590, 30, 8, wallOpt), // ì˜¤ë¥¸ìª½ ì°¨ë‹¨
        ]);

        // í•˜ë‹¨ íšŒì „íŒë“¤ ì œê±° (Xì ë²½ ì œê±°)
        // ëŒ€ì‹  ê°„ë‹¨í•œ ê²½ì‚¬ë¡œë§Œ ì¶”ê°€
        Composite.add(engine.world, [
            Bodies.rectangle(170, 1500, 50, 8, { ...wallOpt, angle: 0.3 }),
            Bodies.rectangle(230, 1520, 50, 8, { ...wallOpt, angle: -0.3 }),
        ]);

        // ìµœì¢… ì¶œêµ¬ ê¹”ë•Œê¸°
        Composite.add(engine.world, [
            Bodies.rectangle(185, 1585, 25, 8, { ...wallOpt, angle: 0.5 }),
            Bodies.rectangle(215, 1585, 25, 8, { ...wallOpt, angle: -0.5 }),
        ]);

        // ì‹œì‘ ê²Œì´íŠ¸
        const gate = Bodies.rectangle(200, 50, 350, 15, { 
            isStatic: true, 
            render: { fillStyle: '#ff0000', opacity: 0.7 },
            label: 'gate'
        });
        Composite.add(engine.world, gate);

        Render.run(render);
        Runner.run(Runner.create(), engine);

        // íšŒì „íŒ ì• ë‹ˆë©”ì´ì…˜ + êµ¬ìŠ¬ ê°‡í˜ ë°©ì§€
        Events.on(engine, 'beforeUpdate', () => {
            spinners.forEach(s => {
                Body.setAngle(s.body, s.body.angle + s.speed);
            });

            // êµ¬ìŠ¬ì´ íšŒì „íŒ ê·¼ì²˜ì— ì˜¤ë˜ ë¨¸ë¬¼ë©´ ë°€ì–´ë‚´ê¸°
            const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && b.label !== 'gate');
            balls.forEach(ball => {
                if (!ball.stuckTimer) ball.stuckTimer = {};
                
                spinners.forEach((s, idx) => {
                    const dx = ball.position.x - s.body.position.x;
                    const dy = ball.position.y - s.body.position.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    // íšŒì „íŒ ê·¼ì²˜ì— ìˆìœ¼ë©´
                    if (dist < 30) {
                        if (!ball.stuckTimer[idx]) {
                            ball.stuckTimer[idx] = Date.now();
                        } else if (Date.now() - ball.stuckTimer[idx] > 2000) { // 2ì´ˆ ì´ìƒ ë¨¸ë¬¼ë©´
                            // ì•„ë˜ë¡œ ê°•ì œë¡œ ë°€ì–´ë‚´ê¸°
                            Body.applyForce(ball, ball.position, { x: 0, y: 0.002 });
                            // ì•½ê°„ ì˜†ìœ¼ë¡œë„ ë°€ì–´ë‚´ê¸°
                            Body.applyForce(ball, ball.position, { x: (Math.random() - 0.5) * 0.001, y: 0 });
                            ball.stuckTimer[idx] = Date.now(); // íƒ€ì´ë¨¸ ë¦¬ì…‹
                        }
                    } else {
                        ball.stuckTimer[idx] = null;
                    }
                });
            });
        });

        // ì´ë¦„í‘œ ë Œë”ë§
        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            ctx.font = "bold 11px sans-serif";
            ctx.textAlign = "center";
            Composite.allBodies(engine.world).forEach(body => {
                if (body.label && body.label !== 'Body' && body.label !== 'gate' && !body.isStatic) {
                    ctx.fillStyle = "rgba(0,0,0,0.7)";
                    const tw = ctx.measureText(body.label).width;
                    ctx.fillRect(body.position.x - tw/2 - 3, body.position.y - 28, tw + 6, 16);
                    ctx.fillStyle = "white";
                    ctx.fillText(body.label, body.position.x, body.position.y - 16);
                }
            });
        });

        let names = [];
        let winCondition = 'first';
        let isRunning = false;
        let marblesCreated = false;

        db.ref(`rooms/${roomId}/config`).on('value', snap => {
            const val = snap.val();
            if (val && val.shouldSetup) {
                document.getElementById('nameInput').value = val.names || "";
                winCondition = val.winType || 'first';
                parseNames(val.names);
                setupMarbles();
                db.ref(`rooms/${roomId}/config/shouldSetup`).set(null);
            }
        });

        db.ref(`rooms/${roomId}/drop`).on('value', snap => { 
            if (snap.val() && marblesCreated) startRace(); 
        });

        db.ref(`rooms/${roomId}/reset`).on('value', snap => {
            if (snap.val()) {
                performReset();
                db.ref(`rooms/${roomId}/reset`).set(null);
            }
        });

        function parseNames(str) {
            names = [];
            str.split(',').forEach(n => {
                let part = n.trim();
                if (part.includes('*')) {
                    let [nm, count] = part.split('*');
                    for (let i = 0; i < (parseInt(count) || 1); i++) names.push(nm.trim());
                } else if (part) names.push(part);
            });
        }

        function setupMarbles() {
            if (isRunning) return;
            
            const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && b.label !== 'gate');
            balls.forEach(b => Composite.remove(engine.world, b));
            
            document.getElementById('resultDisplay').style.display = 'none';

            if (names.length === 0) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                document.getElementById('dropBtn').disabled = true;
                marblesCreated = false;
                return;
            }

            const existingGate = Composite.allBodies(engine.world).find(b => b.label === 'gate');
            if (!existingGate) {
                Composite.add(engine.world, gate);
            }

            names.forEach((name, i) => {
                const ball = Bodies.circle(180 + (Math.random() * 40), 30, 9, {
                    restitution: 0.5, 
                    friction: 0.001, 
                    frictionAir: 0.01,
                    density: 0.001, 
                    label: name,
                    render: { fillStyle: `hsl(${Math.random() * 360}, 80%, 60%)` }
                });
                Composite.add(engine.world, ball);
            });

            marblesCreated = true;
            document.getElementById('dropBtn').disabled = false;
        }

        function saveData() {
            const inputValue = document.getElementById('nameInput').value.trim();
            if (!inputValue) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const config = { 
                names: inputValue, 
                winType: document.querySelector('input[name="winType"]:checked').value,
                shouldSetup: true
            };
            db.ref(`rooms/${roomId}/config`).set(config);
            db.ref(`rooms/${roomId}/drop`).set(null);
        }

        function triggerDrop() { 
            if (marblesCreated) {
                db.ref(`rooms/${roomId}/drop`).set(Date.now()); 
            }
        }

        function resetGame() {
            db.ref(`rooms/${roomId}/reset`).set(Date.now());
        }

        function performReset() {
            const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && b.label !== 'gate');
            balls.forEach(b => Composite.remove(engine.world, b));
            
            const existingGate = Composite.allBodies(engine.world).find(b => b.label === 'gate');
            if (!existingGate) {
                Composite.add(engine.world, gate);
            }
            
            document.getElementById('resultDisplay').style.display = 'none';
            isRunning = false;
            marblesCreated = false;
            names = [];
            document.getElementById('dropBtn').disabled = true;
            document.getElementById('nameInput').value = '';
            
            db.ref(`rooms/${roomId}/config`).set(null);
            db.ref(`rooms/${roomId}/drop`).set(null);
        }

        function startRace() {
            if (isRunning || !marblesCreated) return;
            isRunning = true;
            
            const gateBody = Composite.allBodies(engine.world).find(b => b.label === 'gate');
            if (gateBody) {
                Composite.remove(engine.world, gateBody);
            }
            
            let finished = 0;
            const total = names.length;
            const check = setInterval(() => {
                const balls = Composite.allBodies(engine.world).filter(b => !b.isStatic && b.label !== 'gate');
                balls.forEach(ball => {
                    if (ball.position.y > 1595 && !ball.isDone) {
                        ball.isDone = true;
                        finished++;
                        if (winCondition === 'first' && finished === 1) showWinner(ball.label);
                        else if (winCondition === 'last' && finished === total) showWinner(ball.label);
                    }
                });
                if (finished === total) { 
                    clearInterval(check); 
                    isRunning = false; 
                }
            }, 100);
        }

        function showWinner(name) {
            const res = document.getElementById('resultDisplay');
            res.innerText = `ğŸ† ë‹¹ì²¨ ğŸ†\n${name}`;
            res.style.display = 'block';
        }
    </script>
</body>
</html>
