<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ïã§ÏãúÍ∞Ñ Íµ¨Ïä¨ Îñ®Ïñ¥Îú®Î¶¨Í∏∞ (Marble Run)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { margin: 0; background: #1a1a1b; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        #game-container { position: relative; width: 500px; height: 600px; background: #222; border: 5px solid #333; margin-top: 20px; }
        .controls { background: #333; padding: 15px; border-radius: 10px; width: 470px; margin-top: 10px; z-index: 100; }
        textarea { width: 100%; height: 50px; background: #111; color: white; border: none; padding: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; margin-top: 5px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; }
        #dropBtn { background: #5865F2; color: white; font-size: 1.2rem; }
        #saveBtn { background: #3ba55c; color: white; }
        #resultDisplay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px gold; color: gold; display: none; z-index: 10; }
        .room-info { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="resultDisplay"></div>
    </div>

    <div class="controls">
        <div class="room-info">Î∞© ID: <span id="roomIdDisp"></span></div>
        <textarea id="nameInput" placeholder="Ïù¥Î¶ÑÏùÑ ÏâºÌëúÎ°ú Íµ¨Î∂Ñ (Ïòà: Ï≤†Ïàò, ÏòÅÌù¨, ÎØºÏàò*2)"></textarea>
        <button id="saveBtn" onclick="saveNames()">‚úÖ Î™ÖÎã® Ï†ÄÏû•</button>
        <button id="dropBtn" onclick="triggerDrop()">üîÆ Íµ¨Ïä¨ Îñ®Ïñ¥Îú®Î¶¨Í∏∞!</button>
    </div>

    <script>
        // === [ÏÑ§Ï†ï] Firebase ÏÑ§Ï†ïÍ∞íÏùÑ ÎÑ£ÏúºÏÑ∏Ïöî ===
        const firebaseConfig = {
  apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
  authDomain: "random-game-22f1a.firebaseapp.com",
  databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-game-22f1a",
  storageBucket: "random-game-22f1a.firebasestorage.app",
  messagingSenderId: "1091564497932",
  appId: "1:1091564497932:web:a16dc96fb998166dea9229"
};
        // =====================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Î£∏ ID ÏÑ§Ï†ï
        let roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 7);
        if (!window.location.search.includes('room')) window.history.pushState({}, '', `?room=${roomId}`);
        document.getElementById('roomIdDisp').innerText = roomId;

        // Matter.js ÏÑ§Ï†ï
        const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 500, height: 600, wireframes: false, background: '#222' }
        });

        // Î≤Ω Î∞è Ïû•Ïï†Î¨º ÏÉùÏÑ±
        const wallOptions = { isStatic: true, render: { fillStyle: '#444' } };
        Composite.add(engine.world, [
            Bodies.rectangle(250, 610, 500, 20, wallOptions), // Î∞îÎã•
            Bodies.rectangle(-10, 300, 20, 600, wallOptions), // ÏôºÏ™Ω Î≤Ω
            Bodies.rectangle(510, 300, 20, 600, wallOptions)  // Ïò§Î•∏Ï™Ω Î≤Ω
        ]);

        // ÌïÄ(Ïû•Ïï†Î¨º) Î∞∞Ïπò
        for (let row = 0; row < 7; row++) {
            for (let col = 0; col < 9; col++) {
                let x = col * 55 + (row % 2 === 0 ? 30 : 55);
                let y = row * 70 + 100;
                if (x < 480) {
                    Composite.add(engine.world, Bodies.circle(x, y, 5, { isStatic: true, render: { fillStyle: '#777' } }));
                }
            }
        }

        Render.run(render);
        Runner.run(Runner.create(), engine);

        let names = [];
        const resultDisplay = document.getElementById('resultDisplay');

        // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎèôÍ∏∞Ìôî
        db.ref(`rooms/${roomId}/names`).on('value', snap => {
            const val = snap.val() || "";
            document.getElementById('nameInput').value = val;
            parseNames(val);
        });

        db.ref(`rooms/${roomId}/drop`).on('value', snap => {
            if (snap.val()) dropMarbles();
        });

        function parseNames(str) {
            names = [];
            str.split(',').forEach(n => {
                let part = n.trim();
                if (part.includes('*')) {
                    let [nm, count] = part.split('*');
                    for (let i = 0; i < parseInt(count || 1); i++) names.push(nm.trim());
                } else if (part) {
                    names.push(part);
                }
            });
        }

        function saveNames() {
            db.ref(`rooms/${roomId}/names`).set(document.getElementById('nameInput').value);
        }

        function triggerDrop() {
            db.ref(`rooms/${roomId}/drop`).set(Date.now());
        }

        function dropMarbles() {
            resultDisplay.style.display = 'none';
            // Í∏∞Ï°¥ Íµ¨Ïä¨ Ï†úÍ±∞
            const existingBalls = Composite.allBodies(engine.world).filter(b => !b.isStatic);
            existingBalls.forEach(b => Composite.remove(engine.world, b));

            names.forEach((name, i) => {
                setTimeout(() => {
                    const ball = Bodies.circle(250 + (Math.random() * 40 - 20), 30, 12, {
                        restitution: 0.8,
                        friction: 0.005,
                        label: name,
                        render: { fillStyle: `hsl(${Math.random() * 360}, 70%, 60%)` }
                    });
                    Composite.add(engine.world, ball);
                }, i * 200); // Íµ¨Ïä¨Ïù¥ ÌïòÎÇòÏî© ÏàúÏ∞®Ï†ÅÏúºÎ°ú Îñ®Ïñ¥Ïßê
            });
        }

        // Í≤∞Í≥º Í∞êÏßÄ (Î∞îÎã•Ïóê ÎãøÎäî Íµ¨Ïä¨ ÌôïÏù∏)
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(pair => {
                // Î∞îÎã• Î≤ΩÏùò yÏ¢åÌëú Í∑ºÏ≤òÏóê ÎãøÏúºÎ©¥ ÎãπÏ≤® Ï≤òÎ¶¨
                if (pair.bodyA.position.y > 580 || pair.bodyB.position.y > 580) {
                    const ball = pair.bodyA.isStatic ? pair.bodyB : pair.bodyA;
                    if (!ball.isStatic && resultDisplay.style.display === 'none') {
                        resultDisplay.innerText = ball.label;
                        resultDisplay.style.display = 'block';
                        // ÎãπÏ≤® Ïã†Ìò∏Î•º Î≥¥ÎÇ∏ ÌõÑ 5Ï¥à Îí§Ïóê drop Ïã†Ìò∏ Î¶¨ÏÖã
                        setTimeout(() => db.ref(`rooms/${roomId}/drop`).set(null), 5000);
                    }
                }
            });
        });
    </script>
</body>
</html>
