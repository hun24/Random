<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ë¡œí˜• ì‹¤ì‹œê°„ ë£°ë ›</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        h1 { color: #5865F2; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }

        /* === ë£°ë › ë””ìì¸ (ê°€ë¡œí˜•) === */
        .roulette-wrapper {
            position: relative;
            width: 90%;
            max-width: 800px;
            height: 160px;
            background: #000;
            border: 4px solid #333;
            border-radius: 10px;
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë¶€ë¶„ ìˆ¨ê¹€ */
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* ì¤‘ì•™ ê¸°ì¤€ì„  */
        .marker {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ff4444;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 10px #ff0000;
        }
        .marker::before {
            content: "â–¼";
            position: absolute;
            top: 5px; left: 50%;
            transform: translateX(-50%);
            color: #ff4444; font-size: 20px;
        }

        /* ì›€ì§ì´ëŠ” íŠ¸ë™ */
        .roulette-track {
            display: flex;
            height: 100%;
            align-items: center;
            /* ì´ˆê¸° ìœ„ì¹˜: ì•½ê°„ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            transform: translateX(0px); 
            will-change: transform; /* ì„±ëŠ¥ ìµœì í™” */
        }

        /* ê°œë³„ ì¹´ë“œ ë””ìì¸ */
        .card {
            min-width: 120px;
            height: 120px;
            margin: 0 5px;
            background: #2f3136;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            color: #ddd;
            border-bottom: 4px solid #5865F2;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            text-align: center;
            word-break: keep-all;
            padding: 5px;
        }

        /* ê²°ê³¼ í‘œì‹œ */
        #resultDisplay {
            height: 40px;
            font-size: 28px;
            font-weight: bold;
            color: #fce205;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            margin-bottom: 20px;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            background: #2c2f33;
            padding: 20px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        textarea {
            width: 100%; height: 60px;
            margin-bottom: 10px; padding: 10px;
            border: none; border-radius: 5px;
            background: #18191c; color: white;
            resize: none; font-family: inherit;
        }
        .btn-group { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px;
            border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; font-size: 14px;
            transition: 0.2s;
        }
        #saveBtn { background-color: #3ba55c; color: white; }
        #saveBtn:hover { background-color: #2d7d46; }
        
        #spinBtn {
            background-color: #5865F2; color: white; width: 100%;
            margin-top: 10px; font-size: 18px; padding: 15px;
        }
        #spinBtn:hover { background-color: #4752c4; }
        #spinBtn:disabled { background-color: #555; cursor: not-allowed; }

        .room-info { font-size: 13px; color: #888; margin-bottom: 10px; }
        a { color: #5865F2; text-decoration: none; }
    </style>
</head>
<body>

    <h1>ğŸ† ëœë¤ ë½‘ê¸°</h1>
    <div class="room-info">ë°© ID: <span id="currentRoomId">...</span> (<a href="#" onclick="copyLink()">ë§í¬ ë³µì‚¬</a>)</div>

    <div class="roulette-wrapper">
        <div class="marker"></div>
        <div class="roulette-track" id="track">
            </div>
    </div>

    <div id="resultDisplay"></div>

    <div class="controls">
        <textarea id="itemsInput" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì² ìˆ˜, ì˜í¬*3, ë¯¼ìˆ˜)"></textarea>
        <div class="btn-group">
            <button id="saveBtn" onclick="saveItems()">âœ… ì €ì¥ & ë™ê¸°í™”</button>
        </div>
        <button id="spinBtn" onclick="startSpin()">ğŸ”¥ ëŒë¦¬ê¸°</button>
    </div>

    <script>
        // ========================================================
        // [ì„¤ì •] ì—¬ê¸°ì— Firebase Config ê°ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” 
        // ========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
          authDomain: "random-game-22f1a.firebaseapp.com",
          databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "random-game-22f1a",
          storageBucket: "random-game-22f1a.firebasestorage.app",
          messagingSenderId: "1091564497932",
          appId: "1:1091564497932:web:a16dc96fb998166dea9229"
        };
        // ========================================================

        // ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ë³€ìˆ˜ ì„¤ì •
        const track = document.getElementById('track');
        const itemsInput = document.getElementById('itemsInput');
        const spinBtn = document.getElementById('spinBtn');
        const resultDisplay = document.getElementById('resultDisplay');
        
        // ë£°ë › ì„¤ì •ê°’
        const CARD_WIDTH = 130; // ì¹´ë“œ ë„ˆë¹„(margin í¬í•¨)
        const REPEAT_COUNT = 100; // ë£°ë › ê¸¸ì´ë¥¼ ìœ„í•´ ë¦¬ìŠ¤íŠ¸ ë°˜ë³µ íšŸìˆ˜
        let items = [];
        let isSpinning = false;

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì¹´ë“œ ë°°ê²½ìš©)
        const cardColors = ["#E74C3C", "#8E44AD", "#3498DB", "#1ABC9C", "#F1C40F", "#E67E22"];

        // ----------------- ë°© ID ê´€ë¦¬ -----------------
        let roomId = new URLSearchParams(window.location.search).get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8);
            window.history.pushState({}, '', `?room=${roomId}`);
        }
        document.getElementById('currentRoomId').innerText = roomId;

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // ----------------- Firebase ê°ì§€ (Listen) -----------------
        const roomRef = database.ref('rooms/' + roomId);

        // 1. ì•„ì´í…œ ëª©ë¡ ë³€ê²½ ê°ì§€
        roomRef.child('items').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                itemsInput.value = data;
                updateItemsList(data);
                initTrack(); // íŠ¸ë™ ì´ˆê¸°í™” (ì •ë ¬)
            }
        });

        // 2. ìŠ¤í•€ ëª…ë ¹ ê°ì§€
        roomRef.child('spinStatus').on('value', (snapshot) => {
            const status = snapshot.val();
            if (status && status.spinning && !isSpinning) {
                // ìŠ¤í•€ ì‹œì‘ ì‹ í˜¸ë¥¼ ë°›ìŒ -> ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
                performSpin(status.targetIndex, status.randomOffset);
            } else if (status && !status.spinning) {
                // ìŠ¤í•€ ì¢…ë£Œ ìƒíƒœ (ìƒˆë¡œê³ ì¹¨í•œ ì‚¬ëŒë“¤ì„ ìœ„í•´ ê²°ê³¼ í‘œì‹œ)
                isSpinning = false;
                spinBtn.disabled = false;
            }
        });

        // ----------------- ë¡œì§ í•¨ìˆ˜ë“¤ -----------------

        // í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•´ì„œ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ë³„í‘œ ì²˜ë¦¬ í¬í•¨)
        function updateItemsList(text) {
            const raw = text.split(',').map(s => s.trim()).filter(s => s !== "");
            let newList = [];
            raw.forEach(item => {
                if (item.includes('*')) {
                    const [name, count] = item.split('*');
                    const num = parseInt(count);
                    for(let i=0; i< (num||1); i++) newList.push(name.trim());
                } else {
                    newList.push(item);
                }
            });
            items = newList.length > 0 ? newList : ["ëŒ€ê¸°ì¤‘"];
        }

        // íŠ¸ë™ì— ì¹´ë“œ ë°°ì¹˜ (ì´ˆê¸°í™”)
        function initTrack() {
            if(isSpinning) return;
            track.style.transition = 'none';
            track.style.transform = 'translateX(0px)';
            
            track.innerHTML = ''; // ê¸°ì¡´ ì¹´ë“œ ì‚­ì œ

            // ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë³µí•´ì„œ ì±„ì›Œë„£ì–´ ê¸´ ë ë¥¼ ë§Œë“¦
            // ì¤‘ì•™(í™”ì‚´í‘œ) ìœ„ì¹˜ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ì•ì— ë”ë¯¸ë¥¼ ì¢€ ë‘ 
            // í™”ë©´ ë„ˆë¹„ì˜ ì ˆë°˜ë§Œí¼ íŒ¨ë”©ì„ ì¤˜ì„œ 0ë²ˆ ì¸ë±ìŠ¤ê°€ ì¤‘ì•™ì— ì˜¤ê²Œ í•¨
            const centerPadding = document.querySelector('.roulette-wrapper').offsetWidth / 2 - (CARD_WIDTH / 2);
            
            // ì‹œê°ì  íš¨ê³¼ë¥¼ ìœ„í•´ ë§ì´ ë°˜ë³µ
            let fullList = [];
            for(let i=0; i<REPEAT_COUNT; i++) {
                fullList = fullList.concat(items);
            }

            fullList.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerText = item;
                // ì¹´ë“œ ìƒ‰ìƒì„ ì´ë¦„ì— ë”°ë¼ ê³ ì • (ëœë¤í•´ ë³´ì´ì§€ë§Œ ê°™ì€ ì´ë¦„ì€ ê°™ì€ ìƒ‰)
                const colorIndex = item.charCodeAt(0) % cardColors.length;
                card.style.borderBottomColor = cardColors[colorIndex];
                card.style.color = "#fff";
                track.appendChild(card);
            });
            
            // ì‹œì‘ ìœ„ì¹˜: ì²« ë²ˆì§¸ ì¹´ë“œê°€ ì¤‘ì•™ì— ì˜¤ë„ë¡
             track.style.transform = `translateX(${centerPadding}px)`;
        }

        // ì €ì¥ ë²„íŠ¼
        function saveItems() {
            const text = itemsInput.value;
            roomRef.child('items').set(text);
            alert("ì €ì¥ ì™„ë£Œ!");
        }

        // ëŒë¦¬ê¸° ë²„íŠ¼ (ë¦¬ë”ê°€ ëˆ„ë¦„)
        function startSpin() {
            if (items.length < 2) { alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            if (isSpinning) return;

            // 1. ë‹¹ì²¨ ì¸ë±ìŠ¤ ê³„ì‚° (íŠ¸ë™ì˜ ì¤‘ê°„~ë ë¶€ë¶„ ì‚¬ì´ ì–´ë”˜ê°€)
            // ë„ˆë¬´ ì´ˆë°˜ì— ë©ˆì¶”ë©´ ì¬ë¯¸ì—†ìœ¼ë¯€ë¡œ, ì „ì²´ ê¸¸ì´ì˜ 70% ~ 90% ì§€ì  ì‚¬ì´ì—ì„œ ê²°ì •
            const totalCards = items.length * REPEAT_COUNT;
            const minIndex = Math.floor(totalCards * 0.7); 
            const maxIndex = Math.floor(totalCards * 0.9);
            const targetIndex = Math.floor(Math.random() * (maxIndex - minIndex + 1)) + minIndex;

            // 2. ì¹´ë“œ ë‚´ë¶€ ë¯¸ì„¸ ìœ„ì¹˜ (ì •ì¤‘ì•™ì´ ì•„ë‹ˆë¼ ì•½ê°„ ë¹„ê»´ê°€ê²Œ) -50 ~ 50px
            const randomOffset = Math.floor(Math.random() * 80) - 40; 

            // 3. Firebaseì— ì˜ê¸° (ëª¨ë‘ì—ê²Œ ì´ ìœ„ì¹˜ë¡œ ì´ë™í•˜ë¼ê³  ëª…ë ¹)
            roomRef.child('spinStatus').set({
                spinning: true,
                targetIndex: targetIndex,
                randomOffset: randomOffset,
                timestamp: Date.now()
            });
        }

        // ì‹¤ì œ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ê³µí†µ)
        function performSpin(targetIndex, randomOffset) {
            isSpinning = true;
            spinBtn.disabled = true;
            resultDisplay.innerText = "";
            
            // íŠ¸ë™ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì‹±í¬ ë§ì¶”ê¸° ìœ„í•´)
            initTrack();

            // ëª©í‘œ ìœ„ì¹˜ ê³„ì‚°
            // (í™”ë©´ì¤‘ì•™ê°’) - (íƒ€ê²Ÿì¹´ë“œì˜ ìœ„ì¹˜) + (ë¯¸ì„¸ì¡°ì •)
            const wrapperWidth = document.querySelector('.roulette-wrapper').offsetWidth;
            const centerPadding = wrapperWidth / 2 - (CARD_WIDTH / 2);
            const moveDistance = -(targetIndex * CARD_WIDTH) + centerPadding + randomOffset;

            // CSS Transition ì„¤ì • (ì²œì²œíˆ ë©ˆì¶”ëŠ” íš¨ê³¼)
            // cubic-bezier(0, 0, 0.2, 1) -> ì²˜ìŒì— ë¹ ë¥´ê³  ë‚˜ì¤‘ì— ì²œì²œíˆ
            setTimeout(() => {
                track.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.1, 1)';
                track.style.transform = `translateX(${moveDistance}px)`;
            }, 50); // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì‹¤í–‰

            // 6ì´ˆ í›„ ê²°ê³¼ ë°œí‘œ
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                
                // ì‹¤ì œ ë‹¹ì²¨ëœ í…ìŠ¤íŠ¸ ì°¾ê¸°
                const allCards = document.querySelectorAll('.card');
                if(allCards[targetIndex]) {
                    const winnerName = allCards[targetIndex].innerText;
                    resultDisplay.innerText = `ğŸ‰ ë‹¹ì²¨: ${winnerName} ğŸ‰`;
                    
                    // í­ì£½ íš¨ê³¼ (ê°„ë‹¨í•œ ë°°ê²½ ìƒ‰ ê¹œë¹¡ì„)
                    document.body.style.backgroundColor = "#2a2a2a";
                    setTimeout(() => document.body.style.backgroundColor = "#1a1a1a", 300);
                }

                // DB ìƒíƒœ ë¦¬ì…‹ (ë‹¤ìŒ íŒì„ ìœ„í•´)
                // *ì£¼ì˜: ì—¬ê¸°ì„œ ë¦¬ì…‹í•˜ë©´ ë‹¤ë¥¸ ëŠ¦ê²Œ ë“¤ì–´ì˜¨ ì‚¬ëŒì´ ê²°ê³¼ë¥¼ ëª» ë³¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ
                // ë³´í†µì€ ë¦¬ì…‹í•˜ì§€ ì•Šê±°ë‚˜, ìŠ¤í•€ ì‹œì‘í•  ë•Œ ë®ì–´ì“°ëŠ” ë°©ì‹ì„ ì”€.
                // ì—¬ê¸°ì„œëŠ” 'spinning: false'ë¡œë§Œ ë³€ê²½
                roomRef.child('spinStatus').update({ spinning: false });

            }, 6000); // transition ì‹œê°„ê³¼ ì¼ì¹˜
        }
    </script>
</body>
</html>
