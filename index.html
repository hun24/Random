<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ë£°ë › ê³µìœ </title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; text-align: center; background-color: #2f3136; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        h1 { color: #5865F2; margin-bottom: 10px; }
        
        canvas { border: 5px solid #202225; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px;}
        
        .arrow {
            width: 0; height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #ff4444;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -240px);
            z-index: 10;
        }
        .container { position: relative; }

        /* ì…ë ¥ì°½ ë° ë²„íŠ¼ ë””ìì¸ */
        .controls { background: #40444b; padding: 20px; border-radius: 10px; width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-top: 20px; }
        textarea { width: 100%; height: 80px; margin-bottom: 10px; padding: 10px; border: none; border-radius: 5px; background: #202225; color: white; resize: none; font-family: inherit; font-size: 14px; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        #spinBtn { background-color: #5865F2; color: white; width: 100%; margin-top: 10px; font-size: 18px; padding: 15px; }
        #spinBtn:hover { background-color: #4752c4; }
        #spinBtn:disabled { background-color: #6a718c; cursor: not-allowed; } /* ë¹„í™œì„±í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */

        #updateAndSaveBtn { background-color: #3ba55c; color: white; } /* ì´ˆë¡ìƒ‰: í™”ë©´ ì ìš© ë° ì €ì¥ */
        
        p { font-size: 12px; color: #b9bbbe; margin-top: 5px; }
        .room-id { font-size: 14px; margin-bottom: 15px; color: #b9bbbe; }
        .room-id a { color: #5865F2; text-decoration: none; font-weight: bold; }
        .room-id a:hover { text-decoration: underline; }

        #resultDisplay {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #fce205; /* ë°ì€ ë…¸ë€ìƒ‰ */
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
            height: 30px; /* ê³µê°„ í™•ë³´ */
        }
    </style>
</head>
<body>

    <h1>ğŸ° ì‹¤ì‹œê°„ ë£°ë › ê³µìœ </h1>
    <div class="room-id">
        í˜„ì¬ ë°©: <span id="currentRoomId"></span> - <a href="#" id="shareLink" onclick="copyShareLink()">ë§í¬ ë³µì‚¬</a>
    </div>
    
    <div class="container">
        <div class="arrow"></div>
        <canvas id="wheel" width="400" height="400"></canvas>
    </div>

    <div id="resultDisplay"></div>

    <div class="controls">
        <textarea id="itemsInput" placeholder="ì´ë¦„ì„ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥ (ì˜ˆ: ì² ìˆ˜*2, ì˜í¬)"></textarea>
        
        <div class="btn-group">
            <button id="updateAndSaveBtn" onclick="updateAndSaveItems()">âœ… ì €ì¥ & ë£°ë › ë°˜ì˜</button>
        </div>
        <p>âš ï¸ ë³€ê²½ì‚¬í•­ì€ ì €ì¥í•´ì•¼ ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ê³µìœ ë©ë‹ˆë‹¤.</p>

        <button id="spinBtn" onclick="startSpin()">ğŸ”¥ ëŒë¦¬ê¸° ì‹œì‘!</button>
    </div>

    <script>
        // â˜…â˜…â˜… ì—¬ê¸°ì— Firebase Config ê°ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” 
      // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBWAt4N6PIoY-ZrZQxbqsxauOF0TBcHZ-E",
          authDomain: "random-game-22f1a.firebaseapp.com",
          databaseURL: "https://random-game-22f1a-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "random-game-22f1a",
          storageBucket: "random-game-22f1a.firebasestorage.app",
          messagingSenderId: "1091564497932",
          appId: "1:1091564497932:web:a16dc96fb998166dea9229"
        };
        // ========================================================
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ë£°ë › ê´€ë ¨ DOM ìš”ì†Œ
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const itemsInput = document.getElementById('itemsInput');
        const spinBtn = document.getElementById('spinBtn');
        const resultDisplay = document.getElementById('resultDisplay');

        // ë£°ë › ìƒíƒœ ë³€ìˆ˜
        let items = []; // ì‹¤ì œ ë£°ë ›ì— ê·¸ë ¤ì§ˆ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ (ì¤‘ë³µ ì²˜ë¦¬ëœ)
        let rawItemsString = ""; // Firebaseì— ì €ì¥ë , ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ ë¬¸ìì—´
        let startAngle = 0;
        let arc = 0; // ê° ì„¹ì…˜ì˜ ê°ë„
        let currentSpinRef = null; // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìŠ¤í•€ ë°ì´í„° ë ˆí¼ëŸ°ìŠ¤
        let animationFrameId = null; // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID
        let isSpinningLocal = false; // í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ì´ ì§„í–‰ ì¤‘ì¸ì§€

        const colors = ["#FF5733", "#33FF57", "#3357FF", "#F333FF", "#FF33A8", "#33FFF5", "#F5FF33"];

        // ----------------- ë°© ID ê´€ë¦¬ -----------------
        let roomId = getRoomIdFromUrl();
        if (!roomId) {
            roomId = generateRoomId();
            window.history.pushState({}, '', `?room=${roomId}`); // URLì— ë°© ID ì¶”ê°€
        }
        document.getElementById('currentRoomId').textContent = roomId;

        function getRoomIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 9); // 7ìë¦¬ ëœë¤ ID
        }

        function copyShareLink() {
            const shareUrl = window.location.href;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + shareUrl);
            }).catch(err => {
                console.error('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨:', err);
            });
        }

        // ----------------- Firebase ë°ì´í„° ë¦¬ìŠ¤ë„ˆ -----------------
        const roomRef = database.ref('rooms/' + roomId);

        // ì°¸ê°€ì ëª©ë¡ ë³€ê²½ ê°ì§€
        roomRef.child('items').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                rawItemsString = data;
                itemsInput.value = rawItemsString; // ì…ë ¥ì°½ ì—…ë°ì´íŠ¸
                processAndDrawWheel(); // ë£°ë › ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            } else {
                itemsInput.value = "";
                items = [];
                drawWheel();
            }
        });

        // ë£°ë › ìŠ¤í•€ ìƒíƒœ ë³€ê²½ ê°ì§€ (ëˆ„êµ°ê°€ ëŒë¦¬ê¸°ë¥¼ ì‹œì‘í•˜ë©´)
        roomRef.child('currentSpin').on('value', (snapshot) => {
            const spinData = snapshot.val();
            if (spinData && spinData.spinning && !isSpinningLocal) {
                // ë‹¤ë¥¸ ì‚¬ëŒì´ ìŠ¤í•€ ì‹œì‘! ë‚´ ë¸Œë¼ìš°ì €ì—ì„œë„ ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                startAngle = spinData.startAngle; // ì‹œì‘ ê°ë„ ë™ê¸°í™”
                spinAnimation(spinData.spinTimeTotal, spinData.spinAngleStart, spinData.finalAngle);
                spinBtn.disabled = true;
                resultDisplay.textContent = "";
            } else if (!spinData && isSpinningLocal) {
                // ìŠ¤í•€ ë°ì´í„°ê°€ ì‚¬ë¼ì¡ŒëŠ”ë° ë‚˜ëŠ” ì•„ì§ ìŠ¤í•€ ì¤‘ì´ë©´, ë‚´ ì• ë‹ˆë©”ì´ì…˜ë„ ë©ˆì¶°ì•¼ í•¨ (ì˜¤ë¥˜ ë³µêµ¬)
                cancelAnimationFrame(animationFrameId);
                isSpinningLocal = false;
                spinBtn.disabled = false;
                resultDisplay.textContent = ""; // ê²°ê³¼ ì´ˆê¸°í™”
                drawWheel(); // ë©ˆì¶˜ ìƒíƒœ ê·¸ë¦¬ê¸°
            } else if (spinData && !spinData.spinning && spinData.result && !isSpinningLocal) {
                // ìŠ¤í•€ì´ ì´ë¯¸ ëë‚¬ê³  ê²°ê³¼ê°€ ìˆëŠ”ë°, ë‚´ê°€ ë’¤ëŠ¦ê²Œ ì ‘ì†í–ˆê±°ë‚˜ ê°±ì‹ ëœ ê²½ìš°
                startAngle = spinData.finalAngle;
                drawWheel();
                resultDisplay.textContent = `ğŸ‰ ë‹¹ì²¨: ${spinData.result} ğŸ‰`;
                spinBtn.disabled = false;
            }
        });
        
        // ----------------- ë£°ë › ê·¸ë¦¬ê¸° ë¡œì§ -----------------
        function processAndDrawWheel() {
            const val = itemsInput.value;
            const raw = val.split(',').map(i => i.trim()).filter(i => i !== "");
            
            let processedItems = [];
            raw.forEach(item => {
                if (item.includes('*')) {
                    const [name, countStr] = item.split('*');
                    const num = parseInt(countStr.trim());
                    if (!isNaN(num) && num > 0) {
                        for (let i = 0; i < num; i++) {
                            processedItems.push(name.trim());
                        }
                    } else {
                        processedItems.push(item);
                    }
                } else {
                    processedItems.push(item);
                }
            });

            items = processedItems; // ì‹¤ì œ ë£°ë ›ì— ì“°ì¼ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            drawWheel();
        }

        function drawWheel() {
            if (items.length === 0) {
                ctx.clearRect(0, 0, 400, 400);
                return;
            }
            arc = Math.PI * 2 / items.length;
            ctx.clearRect(0, 0, 400, 400);

            for (let i = 0; i < items.length; i++) {
                const angle = startAngle + i * arc;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.arc(200, 200, 200, angle, angle + arc, false);
                ctx.arc(200, 200, 0, angle + arc, angle, true);
                ctx.fill();
                ctx.save();
                ctx.fillStyle = "white";
                ctx.translate(200 + Math.cos(angle + arc / 2) * 140, 200 + Math.sin(angle + arc / 2) * 140);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                ctx.font = 'bold 16px Arial';
                const text = items[i];
                ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                ctx.restore();
            }
        }

        // ----------------- ì‚¬ìš©ì ì•¡ì…˜ -----------------

        // ì…ë ¥ì°½ ë‚´ìš© Firebaseì— ì €ì¥ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
        function updateAndSaveItems() {
            rawItemsString = itemsInput.value;
            roomRef.child('items').set(rawItemsString)
                .then(() => {
                    alert("âœ… ì°¸ê°€ì ëª©ë¡ì´ ì €ì¥ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
                })
                .catch(error => {
                    console.error("Firebase ì €ì¥ ì‹¤íŒ¨:", error);
                    alert("âŒ ì €ì¥ ì‹¤íŒ¨! ì¸í„°ë„· ì—°ê²° í™•ì¸ ë˜ëŠ” Firebase ì„¤ì • ì˜¤ë¥˜.");
                });
        }

        // ìŠ¤í•€ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ
        function startSpin() {
            if (isSpinningLocal) return; // ì´ë¯¸ ìŠ¤í•€ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (items.length === 0) { alert("ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤!"); return; }

            spinBtn.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
            isSpinningLocal = true; // í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¤í•€ ì‹œì‘ ì•Œë¦¼
            resultDisplay.textContent = "";

            const spinAngleStart = Math.random() * 10 + 10; 
            const spinTimeTotal = Math.random() * 3000 + 4000; // 4~7ì´ˆ íšŒì „

            // ì„ì‹œë¡œ íšŒì „ í›„ ìµœì¢… ê°ë„ ê³„ì‚°
            let tempStartAngle = startAngle;
            let tempSpinTime = 0;
            let tempFinalAngle = 0;

            while(tempSpinTime < spinTimeTotal) {
                const spinAngle = spinAngleStart - (spinAngleStart * (tempSpinTime / spinTimeTotal) * (tempSpinTime / spinTimeTotal)); 
                tempStartAngle += (spinAngle * Math.PI / 180);
                tempSpinTime += 30;
            }
            tempFinalAngle = tempStartAngle; // ê³„ì‚°ëœ ìµœì¢… ê°ë„

            // Firebaseì— ìŠ¤í•€ ì •ë³´ ê¸°ë¡ -> ëª¨ë“  ì ‘ì†ìì—ê²Œ ìŠ¤í•€ ì‹œì‘ ì‹ í˜¸ ì „ë‹¬
            roomRef.child('currentSpin').set({
                spinning: true,
                startAngle: startAngle, // í˜„ì¬ ë‚´ ì‹œì‘ ê°ë„
                spinAngleStart: spinAngleStart,
                spinTimeTotal: spinTimeTotal,
                timestamp: firebase.database.ServerValue.TIMESTAMP // ì–¸ì œ ì‹œì‘í–ˆëŠ”ì§€ ê¸°ë¡
            });

            // ë‚´ ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            spinAnimation(spinTimeTotal, spinAngleStart, tempFinalAngle);
        }

        // ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
        function spinAnimation(spinTimeTotal, spinAngleStart, calculatedFinalAngle) {
            let spinTime = 0;

            function rotate() {
                spinTime += 30;
                if (spinTime >= spinTimeTotal) {
                    stopSpin(calculatedFinalAngle);
                    return;
                }
                const spinAngle = spinAngleStart - (spinAngleStart * (spinTime / spinTimeTotal) * (spinTime / spinTimeTotal)); 
                startAngle += (spinAngle * Math.PI / 180);
                drawWheel();
                animationFrameId = requestAnimationFrame(rotate);
            }
            animationFrameId = requestAnimationFrame(rotate);
        }

        // ìŠ¤í•€ ì¤‘ì§€ ë° ê²°ê³¼ ì²˜ë¦¬
        function stopSpin(finalAngle) {
            cancelAnimationFrame(animationFrameId);
            startAngle = finalAngle; // ìµœì¢… ê°ë„ë¡œ ê³ ì •
            drawWheel();
            isSpinningLocal = false; // ìŠ¤í•€ ì¢…ë£Œ ì•Œë¦¼

            // ê²°ê³¼ ê³„ì‚° (í™”ì‚´í‘œëŠ” ìƒë‹¨ 270ë„/-90ë„ ìœ„ì¹˜ ê¸°ì¤€)
            const degrees = startAngle * 180 / Math.PI + 90;
            const arcd = arc * 180 / Math.PI;
            const index = Math.floor((360 - degrees % 360) % 360 / arcd);
            const result = items[index];

            resultDisplay.textContent = `ğŸ‰ ë‹¹ì²¨: ${result} ğŸ‰`;
            
            // Firebaseì— ê²°ê³¼ ê¸°ë¡ ë° ìŠ¤í•€ ìƒíƒœ ì´ˆê¸°í™” -> ëª¨ë“  ì ‘ì†ìì—ê²Œ ê²°ê³¼ ì „ë‹¬
            roomRef.child('currentSpin').set({
                spinning: false,
                result: result,
                finalAngle: finalAngle, // ìµœì¢… ê°ë„ ì €ì¥
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
                spinBtn.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            });
        }

        // ì´ˆê¸°í™”
        processAndDrawWheel(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ë£°ë › ê·¸ë¦¬ê¸°
    </script>
</body>
</html>
